<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Prediction Monitor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --pm-cyan: #00D9FF;
            --pm-purple: #9D4EDD;
            --pm-panel: rgba(10, 14, 39, 0.95);
            --pm-glow-cyan: rgba(0, 217, 255, 0.30);
            --pm-glow-purple: rgba(157, 78, 221, 0.20);
            --pm-border: rgba(0, 217, 255, 0.55);
        }

        body {
            background: #000000 !important;
            color: #ffffff;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            background:
                radial-gradient(900px circle at 20% 25%, rgba(157, 78, 221, 0.10), transparent 55%),
                radial-gradient(900px circle at 80% 35%, rgba(0, 217, 255, 0.08), transparent 55%),
                radial-gradient(1200px circle at 55% 85%, rgba(157, 78, 221, 0.06), transparent 60%);
        }

        body > * {
            position: relative;
            z-index: 1;
        }

        .startup-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(700px circle at 35% 55%, rgba(139, 92, 246, 0.18), transparent 55%),
                        radial-gradient(800px circle at 65% 45%, rgba(34, 211, 238, 0.14), transparent 60%),
                        linear-gradient(135deg, #020617 0%, #042f2e 45%, #0b1020 100%);
            opacity: 1;
            visibility: visible;
            transform: translateZ(0);
            transition: opacity 400ms ease, visibility 400ms ease;
        }
        .startup-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .startup-shell {
            width: min(1040px, 92vw);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 36px;
            padding: 36px;
        }
        .startup-logo {
            width: 210px;
            height: 210px;
            flex: 0 0 auto;
            filter: drop-shadow(0 0 22px rgba(0, 217, 255, 0.18)) drop-shadow(0 0 26px rgba(157, 78, 221, 0.16));
        }
        .startup-text h1 {
            font-size: 48px;
            line-height: 1.05;
            font-weight: 800;
            letter-spacing: -0.02em;
            color: #ffffff;
        }
        .startup-text p {
            margin-top: 10px;
            font-size: 18px;
            line-height: 1.5;
            color: rgba(148, 163, 184, 0.92);
        }
        .startup-spinner {
            margin-top: 20px;
            width: 54px;
            height: 54px;
            transform-origin: 50% 50%;
            animation: startupSpin 1.1s linear infinite;
        }
        @keyframes startupSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 1024px) {
            .startup-shell { gap: 28px; padding: 28px; }
            .startup-logo { width: 190px; height: 190px; }
            .startup-text h1 { font-size: 40px; }
            .startup-text p { font-size: 16px; }
        }
        @media (max-width: 768px) {
            .startup-shell {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 18px;
                padding: 22px;
            }
            .startup-logo { width: 170px; height: 170px; }
            .startup-text h1 { font-size: 34px; }
            .startup-text p { font-size: 15px; }
            .startup-spinner {
                margin-top: 0;
                position: fixed;
                left: 50%;
                bottom: 42px;
                transform: translateX(-50%);
            }
        }
        .market-card {
            transition: all 0.3s ease;
        }
        .market-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
        .source-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        .source-manifold { background: #fbbf24; color: #78350f; }
        .source-kalshi { background: #60a5fa; color: #1e3a8a; }
        .source-polymarket { background: #34d399; color: #064e3b; }
        .source-limitless { background: #f87171; color: #7f1d1d; }
        .loading-spinner {
            border: 3px solid #374151;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.85);
        }
        .neon-glow {
            box-shadow: 0 0 20px var(--pm-glow-cyan), 0 0 30px var(--pm-glow-purple);
        }
        .neon-glow:hover {
            box-shadow: 0 0 24px rgba(0, 217, 255, 0.42), 0 0 34px rgba(157, 78, 221, 0.28);
        }
        .stat-icon {
            background: linear-gradient(135deg, var(--pm-cyan), var(--pm-purple));
        }

        header {
            border-bottom: 1px solid var(--pm-cyan) !important;
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.10);
        }

        h1, h2, h3 {
            text-shadow: 0 1px 0 rgba(0, 0, 0, 0.75), 0 0 16px rgba(0, 217, 255, 0.10);
        }

        .bg-gray-900,
        .bg-gray-800,
        .bg-gray-950 {
            background: var(--pm-panel) !important;
            border-color: var(--pm-border) !important;
            box-shadow: 0 0 20px var(--pm-glow-cyan), 0 0 30px var(--pm-glow-purple) !important;
        }

        .border-gray-800,
        .border-gray-700 {
            border-color: var(--pm-border) !important;
        }

        .market-card {
            background: rgba(10, 14, 39, 0.72) !important;
            border: 1px solid var(--pm-border) !important;
            box-shadow: 0 0 20px var(--pm-glow-cyan), 0 0 30px var(--pm-glow-purple) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease, filter 0.3s ease;
        }

        .market-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 26px rgba(0, 217, 255, 0.42), 0 0 38px rgba(157, 78, 221, 0.28) !important;
        }

        button {
            background: linear-gradient(135deg, var(--pm-cyan), var(--pm-purple)) !important;
            border: 1px solid rgba(0, 217, 255, 0.65) !important;
            box-shadow: 0 0 18px rgba(0, 217, 255, 0.24), 0 0 26px rgba(157, 78, 221, 0.18);
            transition: transform 0.3s ease, filter 0.3s ease, box-shadow 0.3s ease;
        }

        button:hover {
            filter: brightness(1.07);
            transform: translateY(-1px);
            box-shadow: 0 0 22px rgba(0, 217, 255, 0.34), 0 0 32px rgba(157, 78, 221, 0.24);
        }

        button:disabled {
            opacity: 0.6;
            filter: saturate(0.85);
            cursor: not-allowed;
        }

        .filter-tab {
            background: transparent !important;
            box-shadow: none !important;
            border-left: 0 !important;
            border-right: 0 !important;
            border-top: 0 !important;
            transition: color 0.3s ease, border-color 0.3s ease, filter 0.3s ease;
        }

        .filter-tab:hover {
            filter: drop-shadow(0 0 12px rgba(0, 217, 255, 0.25));
        }

        .filter-tab.active {
            border-bottom-color: var(--pm-cyan) !important;
            color: var(--pm-cyan) !important;
            filter: drop-shadow(0 0 12px rgba(0, 217, 255, 0.28));
        }

        .text-blue-400,
        .text-blue-300 {
            color: var(--pm-cyan) !important;
        }

        .border-blue-500 {
            border-color: var(--pm-cyan) !important;
        }

        .bg-\[\#0001ff\] {
            background: linear-gradient(135deg, var(--pm-cyan), var(--pm-purple)) !important;
        }

        header h1.text-2xl {
            position: relative;
            padding-left: 54px;
            font-size: 0 !important;
            line-height: 1 !important;
            color: transparent !important;
            text-shadow: none !important;
        }

        header h1.text-2xl::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 46px;
            height: 46px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Cdefs%3E%3ClinearGradient id='pmG' x1='40' y1='24' x2='216' y2='232' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%239D4EDD'/%3E%3Cstop offset='0.55' stop-color='%2300D9FF'/%3E%3Cstop offset='1' stop-color='%2300D9FF'/%3E%3C/linearGradient%3E%3ClinearGradient id='pmG2' x1='60' y1='44' x2='196' y2='220' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%239D4EDD'/%3E%3Cstop offset='1' stop-color='%2300D9FF'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M74 78C50 78 34 60 34 44C34 28 46 22 58 22C76 22 90 38 96 54' fill='none' stroke='url(%23pmG)' stroke-width='10' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M182 78C206 78 222 60 222 44C222 28 210 22 198 22C180 22 166 38 160 54' fill='none' stroke='url(%23pmG)' stroke-width='10' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M92 70C104 56 116 50 128 50C140 50 152 56 164 70' fill='none' stroke='url(%23pmG2)' stroke-width='10' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M64 104L92 84H164L192 104L176 188H80L64 104Z' fill='none' stroke='url(%23pmG)' stroke-width='10' stroke-linejoin='round'/%3E%3Cpath d='M108 120C108 108 117 98 128 98C139 98 148 108 148 120' fill='none' stroke='url(%23pmG2)' stroke-width='10' stroke-linecap='round'/%3E%3Cpath d='M94 150C104 138 116 132 128 132C140 132 152 138 162 150' fill='none' stroke='url(%23pmG2)' stroke-width='10' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M112 160C120 154 136 154 144 160' fill='none' stroke='url(%23pmG2)' stroke-width='10' stroke-linecap='round'/%3E%3Ccircle cx='128' cy='86' r='14' fill='none' stroke='url(%23pmG)' stroke-width='10'/%3E%3C/svg%3E");
            filter: drop-shadow(0 0 14px rgba(0, 217, 255, 0.25)) drop-shadow(0 0 18px rgba(157, 78, 221, 0.22));
        }

        header h1.text-2xl::after {
            content: 'Prediction Monitor';
            position: absolute;
            left: 54px;
            top: 50%;
            transform: translateY(-50%);
            color: #ffffff;
            font-size: 24px;
            line-height: 1.2;
            font-weight: 800;
            white-space: nowrap;
            text-shadow: 0 1px 0 rgba(0, 0, 0, 0.75), 0 0 18px rgba(0, 217, 255, 0.18);
        }
    </style>
</head>
<body class="bg-black text-white">
    <div id="startupOverlay" class="startup-overlay" aria-live="polite" aria-busy="true">
        <div class="startup-shell">
            <svg class="startup-logo" viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Samurai logo">
                <defs>
                    <linearGradient id="pmG" x1="40" y1="24" x2="216" y2="232" gradientUnits="userSpaceOnUse">
                        <stop offset="0" stop-color="#9D4EDD"/>
                        <stop offset="0.55" stop-color="#00D9FF"/>
                        <stop offset="1" stop-color="#00D9FF"/>
                    </linearGradient>
                    <linearGradient id="pmG2" x1="60" y1="44" x2="196" y2="220" gradientUnits="userSpaceOnUse">
                        <stop offset="0" stop-color="#9D4EDD"/>
                        <stop offset="1" stop-color="#00D9FF"/>
                    </linearGradient>
                </defs>
                <path d="M74 78C50 78 34 60 34 44C34 28 46 22 58 22C76 22 90 38 96 54" stroke="url(#pmG)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M182 78C206 78 222 60 222 44C222 28 210 22 198 22C180 22 166 38 160 54" stroke="url(#pmG)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M92 70C104 56 116 50 128 50C140 50 152 56 164 70" stroke="url(#pmG2)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M64 104L92 84H164L192 104L176 188H80L64 104Z" stroke="url(#pmG)" stroke-width="10" stroke-linejoin="round"/>
                <path d="M108 120C108 108 117 98 128 98C139 98 148 108 148 120" stroke="url(#pmG2)" stroke-width="10" stroke-linecap="round"/>
                <path d="M94 150C104 138 116 132 128 132C140 132 152 138 162 150" stroke="url(#pmG2)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M112 160C120 154 136 154 144 160" stroke="url(#pmG2)" stroke-width="10" stroke-linecap="round"/>
                <circle cx="128" cy="86" r="14" stroke="url(#pmG)" stroke-width="10"/>
            </svg>
            <div class="startup-text">
                <h1>Prediction Monitor</h1>
                <p>Real-time market data</p>
                <svg class="startup-spinner" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <defs>
                        <linearGradient id="pmSpin" x1="10" y1="10" x2="54" y2="54" gradientUnits="userSpaceOnUse">
                            <stop offset="0" stop-color="#9D4EDD"/>
                            <stop offset="0.55" stop-color="#00D9FF"/>
                            <stop offset="1" stop-color="#00D9FF"/>
                        </linearGradient>
                    </defs>
                    <circle cx="32" cy="32" r="24" stroke="rgba(148,163,184,0.22)" stroke-width="6" />
                    <path d="M56 32C56 18.745 45.255 8 32 8" stroke="url(#pmSpin)" stroke-width="6" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
    </div>
    <!-- Header -->
    <header class="bg-gray-950 shadow-lg border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <h1 class="text-2xl font-bold text-white">üìä Prediction Monitor</h1>
                    <span class="text-sm text-gray-400">Real-time market data</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <button id="loginBtn" onclick="window.location.href='/auth/discord/login'" class="hidden bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition">
                            Login
                        </button>
                        <button id="logoutBtn" onclick="window.location.href='/auth/logout'" class="hidden bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition">
                            Logout
                        </button>
                        <button id="releaseAlertsBtn" onclick="releaseAlerts()" class="hidden bg-yellow-600 hover:bg-yellow-500 text-black px-3 py-2 rounded-lg font-semibold transition">
                            Release Alerts (<span id="queuedAlertsCount">0</span>)
                        </button>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="releaseAlerts()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                            <span>üöÄ</span>
                            <span>Release Alerts (<span id="queuedAlertsCount">0</span>)</span>
                        </button>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="openLeaderboardModal()" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition border border-gray-700">
                            <span>üèÜ</span>
                            <span>Leaderboards</span>
                        </button>
                        <button onclick="openWhaleModal()" class="bg-[#0001ff] hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition neon-glow">
                            <span>üêã</span>
                            <span>Track Wallets</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-900 rounded-lg shadow-lg p-6 border border-gray-800">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-[#0001ff] rounded-md p-3 neon-glow">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-400 truncate">Total Events</dt>
                            <dd class="text-lg font-semibold text-white" id="totalMarkets">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 rounded-lg shadow-lg p-6 border border-gray-800">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-[#0001ff] rounded-md p-3 neon-glow">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-400 truncate">Total Outcomes</dt>
                            <dd class="text-lg font-semibold text-white" id="totalOutcomes">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 rounded-lg shadow-lg p-7 border border-blue-700/60 cursor-pointer" style="box-shadow: 0 0 14px rgba(0, 217, 255, 0.22), 0 0 26px rgba(157, 78, 221, 0.14);" onclick="openReferralModal()">
                <div class="flex items-center">
                    <div class="flex-shrink-0 stat-icon rounded-md p-4 neon-glow">
                        <svg class="h-7 w-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9l-6-6-6 6m12 0v12a2 2 0 01-2 2H8a2 2 0 01-2-2V9m12 0l-6 6-6-6"></path>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-semibold text-gray-200 tracking-wide truncate">Referrals</dt>
                            <dd class="text-2xl font-bold text-white" id="referralEntry">Open</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 rounded-lg shadow-lg p-6 border border-gray-800">
                <div class="flex items-center">
                    <div class="flex-shrink-0 stat-icon rounded-md p-3 neon-glow">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-10V6m0 12v-2m9-4a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-400 truncate">Arbitrage Opps</dt>
                            <dd class="text-lg font-semibold text-white" id="arbitrageCount">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Arbitrage Alerts Section -->
        <div id="arbitrageSection" class="mb-8 hidden">
            <h2 class="text-xl font-bold text-white mb-4">üéØ Arbitrage Opportunities</h2>
            <div id="arbitrageGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Arbitrage cards will be inserted here -->
            </div>
        </div>

        <!-- Whale Alerts Section -->
        <div id="whaleSection" class="mb-8 hidden">
            <h2 class="text-xl font-bold text-white mb-4">üêã Whale Convergence Alerts</h2>
            <div id="whaleGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Whale alerts will be inserted here -->
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="bg-gray-900 rounded-lg shadow-lg mb-6 border border-gray-800">
            <div class="border-b border-gray-700">
                <nav class="flex -mb-px">
                    <button onclick="filterMarkets('all')" class="filter-tab active border-b-2 border-blue-500 py-2 px-6 text-sm font-medium text-blue-400">
                        All Markets
                    </button>
                    <button onclick="filterMarkets('manifold')" class="filter-tab border-b-2 border-transparent py-2 px-6 text-sm font-medium text-gray-400 hover:text-gray-200 hover:border-gray-500">
                        Manifold
                    </button>
                    <button onclick="filterMarkets('kalshi')" class="filter-tab border-b-2 border-transparent py-2 px-6 text-sm font-medium text-gray-400 hover:text-gray-200 hover:border-gray-500">
                        Kalshi
                    </button>
                    <button onclick="filterMarkets('polymarket')" class="filter-tab border-b-2 border-transparent py-2 px-6 text-sm font-medium text-gray-400 hover:text-gray-200 hover:border-gray-500">
                        Polymarket
                    </button>
                    <button onclick="filterMarkets('limitless')" class="filter-tab border-b-2 border-transparent py-2 px-6 text-sm font-medium text-gray-400 hover:text-gray-200 hover:border-gray-500">
                        Limitless
                    </button>
                </nav>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden">
            <div class="flex justify-center items-center py-12">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Markets Grid -->
        <div id="marketsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Market cards will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-300">No markets found</h3>
            <p class="mt-1 text-sm text-gray-500">Try refreshing the data or check your configuration.</p>
        </div>
    </main>

    <div id="leaderboardModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0" onclick="closeLeaderboardModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-950 rounded-lg shadow-xl max-w-4xl w-full relative z-10 border border-gray-800">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">üèÜ Leaderboards</h2>
                        <button onclick="closeLeaderboardModal()" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 mb-4">
                        <button id="leaderboardTabCommunity" onclick="setLeaderboardTab('community')" class="px-3 py-2 rounded-lg text-sm font-semibold bg-[#0001ff] text-white neon-glow">
                            Community
                        </button>
                        <button id="leaderboardTabTrading" onclick="setLeaderboardTab('trading')" class="px-3 py-2 rounded-lg text-sm font-semibold bg-gray-800 text-gray-200 border border-gray-700 hover:bg-gray-700">
                            Trading
                        </button>
                    </div>
                    <div id="leaderboardError" class="hidden text-sm text-red-300 mb-4"></div>
                    <div id="leaderboardContent" class="overflow-x-auto"></div>
                    <div class="flex space-x-3 mt-6">
                        <button onclick="refreshLeaderboardActive()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium transition">
                            Refresh
                        </button>
                        <button onclick="closeLeaderboardModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium transition">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Whale Tracking Modal -->
    <div id="whaleModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0" onclick="closeWhaleModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-950 rounded-lg shadow-xl max-w-lg w-full relative z-10 border border-gray-800">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">üêã Track Wallets</h2>
                        <button onclick="closeWhaleModal()" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <p class="text-gray-400 text-sm mb-4">Add up to 4 wallets to track. Get alerts when multiple wallets bet on the same market.</p>
                    
                    <div id="walletInputs" class="space-y-4">
                        <!-- Wallet inputs will be generated here -->
                    </div>
                    
                    <div class="mt-6 flex space-x-3">
                        <button onclick="saveWallets()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium transition">
                            üíæ Save Wallets
                        </button>
                        <button onclick="closeWhaleModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium transition">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="referralModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0" onclick="closeReferralModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-950 rounded-lg shadow-xl max-w-5xl w-full relative z-10 border border-gray-800">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">üéüÔ∏è Referrals</h2>
                        <button onclick="closeReferralModal()" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="bg-gray-900 rounded-lg shadow-lg p-5 border border-gray-800 mb-5">
                        <div class="flex items-center justify-between gap-4">
                            <div class="min-w-0">
                                <div class="text-base font-semibold text-white">Your Referral Link</div>
                                <div class="text-sm text-gray-400 mt-1">Share this link to earn rewards from your referrals.</div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <input id="referralLinkInput" readonly class="w-full bg-black/40 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-200" value="Loading..." />
                                    <button onclick="copyReferralLink()" class="px-3 py-2 rounded-lg text-sm font-semibold bg-[#0001ff] text-white neon-glow">Copy</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                        <div class="bg-gray-900 rounded-lg shadow-lg p-5 border border-gray-800">
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-400">Total Referrals</div>
                                <div id="refTotalReferrals" class="text-lg font-semibold text-white">0</div>
                            </div>
                        </div>
                        <div class="bg-gray-900 rounded-lg shadow-lg p-5 border border-gray-800">
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-400">Total Earnings</div>
                                <div id="refTotalEarnings" class="text-lg font-semibold" style="color: var(--pm-cyan);">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                        <div class="bg-gray-900 rounded-lg shadow-lg p-5 border border-gray-800">
                            <div class="text-base font-semibold text-white mb-3">Referral Stats</div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Total Referrals</span><span id="refStatsReferrals" class="text-white">0</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Total Earnings</span><span id="refStatsEarnings" style="color: var(--pm-cyan);">$0.00</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Total Volume</span><span id="refStatsVolume" class="text-white">$0.00</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Loading</span><span id="refStatsLoading" class="text-white">No</span></div>
                            </div>
                        </div>
                        <div class="bg-gray-900 rounded-lg shadow-lg p-5 border border-gray-800">
                            <div class="text-base font-semibold text-white mb-3">Referral Leaders</div>
                            <div id="refLeaders" class="text-sm" style="max-height: 200px; overflow: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allMarkets = {};
        let currentFilter = 'all';
        let trackedWallets = [];
        const MAX_WALLETS = 4;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadMe();
            loadTrackedWallets();
            loadMarkets();
            loadArbitrageOpportunities();
            loadWhaleAlerts();
            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadQueuedAlertsCount();
                if (isLeaderboardModalOpen()) {
                    refreshLeaderboardActive();
                }
                loadMarkets();
                loadArbitrageOpportunities();
                loadWhaleAlerts();
            }, 30000);
        });

        async function loadMe() {
            try {
                const r = await axios.get('/api/me');
                const me = r.data || {};
                const authed = !!me.authenticated;
                document.getElementById('loginBtn').classList.toggle('hidden', authed);
                document.getElementById('logoutBtn').classList.toggle('hidden', !authed);
                document.getElementById('releaseAlertsBtn').classList.toggle('hidden', !authed);
                if (authed) {
                    loadQueuedAlertsCount();
                }
            } catch (e) {
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('releaseAlertsBtn').classList.add('hidden');
            }
        }

        async function loadQueuedAlertsCount() {
            try {
                const r = await axios.get('/api/alerts/queued');
                const count = r.data?.count ?? 0;
                document.getElementById('queuedAlertsCount').textContent = count;
            } catch (e) {
                document.getElementById('queuedAlertsCount').textContent = '0';
            }
        }

        function beep() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const ctx = new AudioContext();
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'sine';
                o.frequency.value = 880;
                g.gain.value = 0.05;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                setTimeout(() => {
                    o.stop();
                    ctx.close();
                }, 180);
            } catch (e) {
                return;
            }
        }

        async function releaseAlerts() {
            try {
                const r = await axios.post('/api/alerts/release', {});
                const released = r.data?.released ?? 0;
                showSuccess(`Released ${released} alerts to Discord DM`);
                beep();
                loadQueuedAlertsCount();
            } catch (e) {
                const status = e?.response?.status;
                if (status === 401) {
                    showError('Please login with Discord first');
                    loadMe();
                    return;
                }
                const err = e?.response?.data?.error;
                showError(err ? `Release failed: ${err}` : 'Release failed');
            }
        }

        // Wallet Tracking Functions
        function loadTrackedWallets() {
            const saved = localStorage.getItem('trackedWallets');
            if (saved) {
                trackedWallets = JSON.parse(saved);
            } else {
                trackedWallets = [];
            }
        }

        function openWhaleModal() {
            document.getElementById('whaleModal').classList.remove('hidden');
            renderWalletInputs();
        }

        function closeWhaleModal() {
            document.getElementById('whaleModal').classList.add('hidden');
        }

        function openReferralModal() {
            document.getElementById('referralModal').classList.remove('hidden');
            loadReferralModal();
        }

        function closeReferralModal() {
            document.getElementById('referralModal').classList.add('hidden');
        }

        async function loadReferralModal() {
            const linkInput = document.getElementById('referralLinkInput');
            if (linkInput) linkInput.value = 'Loading...';

            try {
                const res = await axios.get('/api/referral/code');
                const link = res.data?.referral_link || '';
                if (linkInput) linkInput.value = link || 'Unavailable';
            } catch (e) {
                if (linkInput) linkInput.value = 'Login required';
            }

            const leadersEl = document.getElementById('refLeaders');
            if (leadersEl) leadersEl.innerHTML = '<div class="text-gray-400">Loading...</div>';
            try {
                const res = await axios.get('/api/leaderboard/community');
                const leaders = (res.data?.leaders || []).slice(0, 8);
                if (leadersEl) {
                    leadersEl.innerHTML = leaders.map((r, i) => {
                        const label = (r.wallet || r.user_id || '').toString();
                        const short = label.length > 12 ? (label.slice(0, 6) + '...' + label.slice(-4)) : label;
                        const pts = (r.points_earned != null) ? String(r.points_earned) : '0';
                        const conv = (r.referrals_converted != null) ? String(r.referrals_converted) : '0';
                        return `
                            <div class="flex items-center justify-between py-1 border-b border-gray-800">
                                <div class="text-gray-300">#${i + 1} ${short}</div>
                                <div class="text-gray-400">${conv} conv</div>
                                <div style="color: var(--pm-cyan);" class="font-semibold">${pts} pts</div>
                            </div>
                        `;
                    }).join('') || '<div class="text-gray-400">No leaders yet.</div>';
                }
            } catch (e) {
                if (leadersEl) leadersEl.innerHTML = '<div class="text-gray-400">Unable to load leaders.</div>';
            }
        }

        function copyReferralLink() {
            const el = document.getElementById('referralLinkInput');
            const text = el ? String(el.value || '') : '';
            if (!text || text === 'Loading...' || text === 'Login required' || text === 'Unavailable') {
                return;
            }
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => showSuccess('Copied referral link!')).catch(() => {});
            } else {
                try {
                    el.select();
                    document.execCommand('copy');
                    showSuccess('Copied referral link!');
                } catch (e) {
                }
            }
        }

        function renderWalletInputs() {
            const container = document.getElementById('walletInputs');
            let html = '';
            
            for (let i = 0; i < MAX_WALLETS; i++) {
                const wallet = trackedWallets[i] || { label: '', address: '', platform: 'manifold' };
                html += `
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="flex items-center space-x-2 mb-3">
                            <span class="text-lg">${i + 1}.</span>
                            <input type="text" 
                                   id="walletLabel${i}" 
                                   value="${wallet.label}" 
                                   placeholder="Wallet name (e.g., Sharp Trader)" 
                                   class="flex-1 bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">
                        </div>
                        <div class="flex space-x-2">
                            <select id="walletPlatform${i}" class="bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                                <option value="manifold" ${wallet.platform === 'manifold' ? 'selected' : ''}>Manifold</option>
                                <option value="polymarket" ${wallet.platform === 'polymarket' ? 'selected' : ''}>Polymarket</option>
                                <option value="limitless" ${wallet.platform === 'limitless' ? 'selected' : ''}>Limitless</option>
                            </select>
                            <input type="text" 
                                   id="walletAddress${i}" 
                                   value="${wallet.address}" 
                                   placeholder="Username or wallet address" 
                                   class="flex-1 bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        async function saveWallets() {
            const wallets = [];
            for (let i = 0; i < MAX_WALLETS; i++) {
                const label = document.getElementById(`walletLabel${i}`).value.trim();
                const address = document.getElementById(`walletAddress${i}`).value.trim();
                const platform = document.getElementById(`walletPlatform${i}`).value;
                
                if (address) {
                    wallets.push({ label: label || `Wallet ${i + 1}`, address, platform });
                }
            }
            
            trackedWallets = wallets;
            localStorage.setItem('trackedWallets', JSON.stringify(wallets));
            
            // Save to server
            try {
                await axios.post('/api/wallets', { wallets });
                showSuccess('Wallets saved successfully!');
                closeWhaleModal();
                loadWhaleAlerts();
            } catch (error) {
                console.error('Error saving wallets:', error);
                showError('Failed to save wallets to server, but saved locally.');
                closeWhaleModal();
            }
        }

        // Arbitrage Functions
        async function loadArbitrageOpportunities() {
            try {
                const response = await axios.get('/api/arbitrage');
                const opportunities = response.data.opportunities || [];
                
                document.getElementById('arbitrageCount').textContent = opportunities.length;
                
                if (opportunities.length > 0) {
                    document.getElementById('arbitrageSection').classList.remove('hidden');
                    renderArbitrageCards(opportunities);
                } else {
                    document.getElementById('arbitrageSection').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading arbitrage:', error);
            }
        }

        function renderArbitrageCards(opportunities) {
            const grid = document.getElementById('arbitrageGrid');
            grid.innerHTML = opportunities.slice(0, 6).map(opp => `
                <div class="bg-gray-800 rounded-lg shadow-lg p-4 border border-gray-700">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-2xl">${opp.action?.signal || 'üü°'}</span>
                        <span class="text-green-400 font-bold">+${opp.action?.profit_cents || (opp.spread * 100).toFixed(1)}¬¢</span>
                    </div>
                    <h3 class="text-white font-medium mb-2 text-sm">${opp.markets?.[0]?.title || opp.normalized_title}</h3>
                    <div class="text-sm text-gray-400 mb-3">
                        ${opp.action?.explanation || `Spread: ${(opp.spread * 100).toFixed(1)}%`}
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${opp.sources.map(s => `<span class="source-badge source-${s}">${s.toUpperCase()}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Whale Alert Functions
        async function loadWhaleAlerts() {
            if (trackedWallets.length === 0) {
                document.getElementById('whaleSection').classList.add('hidden');
                return;
            }
            
            try {
                const response = await axios.get('/api/whales');
                const alerts = response.data.alerts || [];
                
                if (alerts.length > 0) {
                    document.getElementById('whaleSection').classList.remove('hidden');
                    renderWhaleCards(alerts);
                } else {
                    document.getElementById('whaleSection').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading whale alerts:', error);
            }
        }

        function renderWhaleCards(alerts) {
            const grid = document.getElementById('whaleGrid');
            grid.innerHTML = alerts.slice(0, 6).map(alert => `
                <div class="bg-gray-800 rounded-lg shadow-lg p-4 border border-gray-700">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-2xl">${alert.signal || 'üêã'}</span>
                        <span class="text-purple-400 font-bold">${alert.count} whales</span>
                    </div>
                    <h3 class="text-white font-medium mb-2 text-sm">${alert.title || alert.market_id}</h3>
                    <div class="text-sm text-gray-400 mb-3">${alert.action || 'Multiple tracked wallets active'}</div>
                    <div class="flex flex-wrap gap-2">
                        ${alert.wallets?.map(w => `<span class="bg-purple-900 text-purple-200 text-xs px-2 py-1 rounded">${w.label || w.platform}</span>`).join('') || ''}
                    </div>
                </div>
            `).join('');
        }

        let activeLeaderboardTab = 'community';

        function isLeaderboardModalOpen() {
            const el = document.getElementById('leaderboardModal');
            if (!el) return false;
            return !el.classList.contains('hidden');
        }

        function openLeaderboardModal() {
            const el = document.getElementById('leaderboardModal');
            if (!el) return;
            el.classList.remove('hidden');
            setLeaderboardTab(activeLeaderboardTab);
        }

        function closeLeaderboardModal() {
            const el = document.getElementById('leaderboardModal');
            if (!el) return;
            el.classList.add('hidden');
        }

        function setLeaderboardTab(tab) {
            activeLeaderboardTab = (tab === 'trading') ? 'trading' : 'community';
            const btnC = document.getElementById('leaderboardTabCommunity');
            const btnT = document.getElementById('leaderboardTabTrading');
            if (btnC && btnT) {
                if (activeLeaderboardTab === 'community') {
                    btnC.className = "px-3 py-2 rounded-lg text-sm font-semibold bg-[#0001ff] text-white neon-glow";
                    btnT.className = "px-3 py-2 rounded-lg text-sm font-semibold bg-gray-800 text-gray-200 border border-gray-700 hover:bg-gray-700";
                } else {
                    btnT.className = "px-3 py-2 rounded-lg text-sm font-semibold bg-[#0001ff] text-white neon-glow";
                    btnC.className = "px-3 py-2 rounded-lg text-sm font-semibold bg-gray-800 text-gray-200 border border-gray-700 hover:bg-gray-700";
                }
            }
            refreshLeaderboardActive();
        }

        async function refreshLeaderboardActive() {
            if (!isLeaderboardModalOpen()) {
                return;
            }
            if (activeLeaderboardTab === 'trading') {
                await loadTradingLeaderboard();
            } else {
                await loadCommunityLeaderboard();
            }
        }

        function showLeaderboardError(msg) {
            const el = document.getElementById('leaderboardError');
            if (!el) return;
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function clearLeaderboardError() {
            const el = document.getElementById('leaderboardError');
            if (!el) return;
            el.textContent = '';
            el.classList.add('hidden');
        }

        function fmtNum(v) {
            if (v == null) return '0';
            const n = Number(v);
            if (Number.isNaN(n)) return '0';
            return n.toLocaleString();
        }

        function fmtMoney(v) {
            if (v == null) return '0.00';
            const n = Number(v);
            if (Number.isNaN(n)) return '0.00';
            return n.toFixed(2);
        }

        function fmtPct(v) {
            if (v == null) return '0.0%';
            const n = Number(v);
            if (Number.isNaN(n)) return '0.0%';
            return n.toFixed(1) + '%';
        }

        async function loadCommunityLeaderboard() {
            try {
                clearLeaderboardError();
                const res = await axios.get('/api/leaderboard/community');
                const leaders = res.data.leaders || [];
                renderCommunityLeaderboard(leaders);
            } catch (e) {
                showLeaderboardError('Failed to load community leaderboard');
            }
        }

        function renderCommunityLeaderboard(leaders) {
            const el = document.getElementById('leaderboardContent');
            if (!el) return;
            const rows = (leaders || []).slice(0, 50).map((r, i) => `
                <tr class="border-b border-gray-800">
                    <td class="py-2 pr-4 text-gray-300">${i + 1}</td>
                    <td class="py-2 pr-4 text-gray-200">${r.tier_status || ''}</td>
                    <td class="py-2 pr-4 text-gray-200">${fmtNum(r.points_earned)}</td>
                    <td class="py-2 pr-4 text-gray-300">${fmtNum(r.referrals_signed_up)}</td>
                    <td class="py-2 pr-4 text-gray-300">${fmtNum(r.referrals_converted)}</td>
                    <td class="py-2 pr-4 text-gray-300">${fmtMoney(r.commission_earned)}</td>
                </tr>
            `).join('');

            el.innerHTML = `
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-gray-800">
                            <th class="py-2 pr-4 font-semibold">Rank</th>
                            <th class="py-2 pr-4 font-semibold">Tier</th>
                            <th class="py-2 pr-4 font-semibold">Points</th>
                            <th class="py-2 pr-4 font-semibold">Signups</th>
                            <th class="py-2 pr-4 font-semibold">Conversions</th>
                            <th class="py-2 pr-4 font-semibold">Commission</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows || ''}
                    </tbody>
                </table>
            `;
        }

        async function loadTradingLeaderboard() {
            try {
                clearLeaderboardError();
                const res = await axios.get('/api/leaderboard/trading');
                const leaders = res.data.leaders || [];
                renderTradingLeaderboard(leaders);
            } catch (e) {
                showLeaderboardError('Failed to load trading leaderboard');
            }
        }

        function renderTradingLeaderboard(leaders) {
            const el = document.getElementById('leaderboardContent');
            if (!el) return;
            const rows = (leaders || []).slice(0, 50).map((r, i) => `
                <tr class="border-b border-gray-800">
                    <td class="py-2 pr-4 text-gray-300">${i + 1}</td>
                    <td class="py-2 pr-4 text-gray-200">${r.wallet || ''}</td>
                    <td class="py-2 pr-4 text-gray-200">${fmtNum(r.trade_count)}</td>
                    <td class="py-2 pr-4 text-gray-300">${fmtPct(r.win_rate_pct)}</td>
                    <td class="py-2 pr-4 text-gray-300">${fmtMoney(r.total_pnl_all_time)}</td>
                    <td class="py-2 pr-4 text-gray-300">${fmtMoney(r.total_pnl_30d)}</td>
                    <td class="py-2 pr-4 text-gray-300">${fmtMoney(r.total_pnl_7d)}</td>
                </tr>
            `).join('');

            el.innerHTML = `
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-gray-800">
                            <th class="py-2 pr-4 font-semibold">Rank</th>
                            <th class="py-2 pr-4 font-semibold">Wallet</th>
                            <th class="py-2 pr-4 font-semibold">Trades</th>
                            <th class="py-2 pr-4 font-semibold">Win Rate</th>
                            <th class="py-2 pr-4 font-semibold">P&L (All)</th>
                            <th class="py-2 pr-4 font-semibold">P&L (30D)</th>
                            <th class="py-2 pr-4 font-semibold">P&L (7D)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows || ''}
                    </tbody>
                </table>
            `;
        }

        // Market Functions
        async function loadMarkets() {
            showLoading(true);
            try {
                const response = await axios.get('/api/markets');
                allMarkets = response.data.markets;
                updateStats(response.data);
                displayMarkets();
                updateLastRefresh();
            } catch (error) {
                console.error('Error loading markets:', error);
                showError('Failed to load market data');
            } finally {
                showLoading(false);
                if (!window.__startupOverlayDone) {
                    window.__startupOverlayDone = true;
                    hideStartupOverlay();
                }
            }
        }

        async function refreshData() {
            const button = event.target.closest('button');
            const originalContent = button.innerHTML;
            button.innerHTML = '<div class="loading-spinner w-4 h-4"></div> Refreshing...';
            button.disabled = true;
            
            try {
                await axios.get('/api/refresh');
                await loadMarkets();
                await loadArbitrageOpportunities();
                await loadWhaleAlerts();
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError('Failed to refresh data');
            } finally {
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        }

        function filterMarkets(source) {
            currentFilter = source;
            
            // Update tab styles
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-400');
                tab.classList.add('border-transparent', 'text-gray-400');
            });
            event.target.classList.remove('border-transparent', 'text-gray-400');
            event.target.classList.add('border-blue-500', 'text-blue-400');
            
            displayMarkets();
        }

        function displayMarkets() {
            const grid = document.getElementById('marketsGrid');
            const emptyState = document.getElementById('emptyState');
            
            let marketsToShow = [];
            if (currentFilter === 'all') {
                Object.values(allMarkets).forEach(sourceMarkets => {
                    marketsToShow.push(...sourceMarkets);
                });
            } else if (allMarkets[currentFilter]) {
                marketsToShow = allMarkets[currentFilter];
            }
            
            if (marketsToShow.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            grid.innerHTML = marketsToShow.map(market => createMarketCard(market)).join('');
        }

        function createMarketCard(market) {
            const yesOutcome = market.outcomes.find(o => o.name === 'YES');
            const noOutcome = market.outcomes.find(o => o.name === 'NO');

            const marketUrl = (market && typeof market.url === 'string') ? market.url.trim() : '';
            
            return `
                <div class="market-card bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700">
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-white mb-1">${market.title}</h3>
                                <span class="source-badge source-${market.source}">${market.source.toUpperCase()}</span>
                            </div>
                            ${marketUrl ? `
                                <a href="${marketUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>
                            ` : `
                                <span class="text-gray-600 cursor-not-allowed">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </span>
                            `}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-green-900/30 border border-green-700/50 rounded-lg p-3">
                                <div class="text-sm font-medium text-green-400">YES</div>
                                <div class="text-lg font-bold text-green-300">
                                    ${yesOutcome?.mid != null ? formatPrice(yesOutcome.mid) : 'N/A'}
                                </div>
                                ${(yesOutcome?.bid != null && yesOutcome?.ask != null) ? `
                                    <div class="text-xs text-green-500 mt-1">
                                        Bid: ${formatPrice(yesOutcome.bid)} | Ask: ${formatPrice(yesOutcome.ask)}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-3">
                                <div class="text-sm font-medium text-red-400">NO</div>
                                <div class="text-lg font-bold text-red-300">
                                    ${noOutcome?.mid != null ? formatPrice(noOutcome.mid) : 'N/A'}
                                </div>
                                ${(noOutcome?.bid != null && noOutcome?.ask != null) ? `
                                    <div class="text-xs text-red-500 mt-1">
                                        Bid: ${formatPrice(noOutcome.bid)} | Ask: ${formatPrice(noOutcome.ask)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${(yesOutcome?.mid != null && noOutcome?.mid != null) ? `
                            <div class="mt-3 pt-3 border-t border-gray-700">
                                <div class="flex justify-between text-sm text-gray-400">
                                    <span>Spread: ${Math.abs(yesOutcome.mid - noOutcome.mid).toFixed(3)}</span>
                                    <span>Updated: ${formatTime(market.last_updated)}</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function formatPrice(price) {
            return (price * 100).toFixed(1) + '%';
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }

        function updateStats(data) {
            document.getElementById('totalMarkets').textContent = (data.total_events ?? data.total_markets ?? 0);
            const sourcesEl = document.getElementById('activeSources');
            if (sourcesEl) {
                sourcesEl.textContent = (data.active_sources ?? (data.sources ? data.sources.length : 0));
            }
            
            // Calculate total outcomes
            let totalOutcomes = 0;
            Object.values(data.markets).forEach(sourceMarkets => {
                sourceMarkets.forEach(market => {
                    totalOutcomes += market.outcomes.length;
                });
            });
            document.getElementById('totalOutcomes').textContent = totalOutcomes;
        }

        function updateLastRefresh() {
            const now = new Date();
            const el = document.getElementById('lastUpdateTime');
            if (el) {
                el.textContent = now.toLocaleTimeString();
            }
            const el2 = document.getElementById('lastUpdate');
            if (el2) {
                el2.textContent = 'Last updated: ' + now.toLocaleTimeString();
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            const grid = document.getElementById('marketsGrid');
            
            if (show) {
                loading.classList.remove('hidden');
                grid.classList.add('hidden');
            } else {
                loading.classList.add('hidden');
                grid.classList.remove('hidden');
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function hideStartupOverlay() {
            const el = document.getElementById('startupOverlay');
            if (!el) return;
            el.classList.add('hidden');
        }

        window.addEventListener('load', function() {
            if (!window.__startupOverlayDone) {
                setTimeout(() => {
                    if (!window.__startupOverlayDone) {
                        window.__startupOverlayDone = true;
                        hideStartupOverlay();
                    }
                }, 30000);
            }
        });
    </script>
</body>
</html>
